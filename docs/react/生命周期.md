## 生命周期函数

### 一、组件在初始化时会触发 5 个钩子函数：

dufaultProps{}

设置默认的 props，es6 中用 static dufaultProps={} 设置组件的默认属性。在整个生命周期只执行一次。

constructor(props)

可以直接在 constructor 中定义 this.state。此时可以访问 this.props。

componentWillMount() 能在一次渲染中多次调用.

组件初始化时调用，以后组件更新不调用，整个生命周期只调用一次，此时可以修改 state。

render()

React 最重要的步骤，创建虚拟 dom，进行 diff 算法，更新 dom 树都在此进行。此时就不能更改 state 了。

componentDidMount()

目前官方推荐的异步请求是在 componentDidMount 中进行.因为 render 或者 componentWillMount 可能重复多次执行。

组件渲染之后调用，可以通过 this.getDOMNode()获取和操作 dom 节点，只调用一次。

#### 父子组件渲染

- father constructor father
- father componentWillMount
- father render
- child constructor 1
- child componentWillMount
- child render
- child componentDidMount
- father componentDidMount

### 二、在更新时也会触发 5 个钩子函数：

componentWillReceivePorps(nextProps)

组件初始化时不调用，组件接受新的 props 时调用。不管父组件传递给子组件的 props 有没有改变，都会触发。

shouldComponentUpdate(nextProps, nextState) 必须返回 true 或 false 返回 false 不往下走

React 性能优化非常重要的一环。组件接受新的 state 或者 props 时调用，我们可以设置在此对比前后两个 props 和 state 是否相同，如果相同则返回 false 阻止更新，因为相同的属性状态一定会生成相同的 dom 树，这样就不需要创造新的 dom 树和旧的 dom 树进行 diff 算法对比，节省大量性能，尤其是在 dom 结构复杂的时候。不过调用 this.forceUpdate 会跳过此步骤。

我们还可以在创建组件的时候继承 PureComponent，因为它用当前与之前 props 和 state 的浅比较覆写了 shouldComponentUpdate() 的实现。也能达到性能优化。

componentWillUpdate(nextProps, nextState)

组件初始化时不调用，只有在组件将要更新时才调用，此时可以修改 state

render()

不多说

componentDidUpdate(preProps, preState)

组件初始化时不调用，组件更新完成后调用，此时可以获取 dom 节点。

#### 父子组件更新渲染

- father shouldComponentUpdate {name: "father"} {count: 2}
- father componentWillUpdate 组件将要更新
- father render
- child componentWillReceiveProps
- child shouldComponentUpdate {count: 2, name: "child"} null
- child componentWillUpdate 组件将要更新
- child render
- child componentDidUpdate 组件更新完毕
- father componentDidUpdate 组件更新完毕

### 三、卸载钩子函数

componentWillUnmount() 定时器的清除
组件将要卸载时调用，一些事件监听和定时器需要在此时清除。

### 新的生命周期方法

React 16 之后有三个生命周期被废弃(但并未删除)componentWillReceivePorps componentWillUpdate componentWillMount 新增如下两个生命周期函数

static getDerivedStateFromProps(nextProps,prevState)：接收父组件传递过来的 props 和组件之前的状态，返回一个对象来更新 state 或者返回 null 来表示接收到的 props 没有变化，不需要更新 state。此方法在更新和挂载阶段都可能会调用

getSnapshotBeforeUpdate(prevProps, prevState)：接收父组件传递过来的 props 和组件之前的状态，此生命周期钩子必须有返回值，返回值将作为第三个参数传递给 componentDidUpdate。必须和 componentDidUpdate 一起使用，否则会报错
该生命周期钩子触发的时机 ：被调用于 render 之后、componentDidUpdate 之前

#### 新版本父子组件渲染

在新版本中 getDerivedStateFromProps 方法会替换 componentWillMount、componentWillReceiveProps、componentWillUpdate

- father constructor father
- father getDerivedStateFromProps {name: "father"} {count: 1}
- father render
- child constructor 1
- child getDerivedStateFromProps {count: 1, name: "child"} {}
- child render
- child componentDidMount
- father componentDidMount

#### 新版本父子组件渲染

- father getDerivedStateFromProps {name: "father"} {count: 2}
- father shouldComponentUpdate {name: "father"} {count: 2}
- father render
- child getDerivedStateFromProps {count: 2, name: "child"} {}
- child shouldComponentUpdate {count: 2, name: "child"} {}
- child render
- child getSnapshotBeforeUpdate {count: 1, name: "child"} {}
- father getSnapshotBeforeUpdate {name: "father"} {count: 1}
- child componentDidUpdate 组件更新完毕
- father componentDidUpdate 组件更新完毕
